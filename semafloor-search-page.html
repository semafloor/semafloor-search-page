<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../jv-datepicker/jv-datepicker-dialog.html">
<link rel="import" href="../compound-timepicker/compound-timepicker-dialog.html">

<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-pages/iron-pages.html">

<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-item/paper-icon-item.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../paper-ripple/paper-ripple.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../paper-radio-button/paper-radio-button.html">
<link rel="import" href="../paper-radio-group/paper-radio-group.html">

<link rel="import" href="../firebase-element/firebase-collection.html">

<link rel="import" href="../neon-animation/animations/transform-animation.html">

<!--
An element providing a solution to no problem in particular.

Example:

    <semafloor-search-page></semafloor-search-page>

@group Seed Elements
@element semafloor-search-page
@demo demo/index.html
@hero hero.svg
-->
<dom-module id="semafloor-search-page">
  <template strip-whitespace>
    <style>
      :host {
        -webkit-user-select: none;
           -moz-user-select: none;
            -ms-user-select: none;
                user-select: none;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
        -webkit-tap-highlight-color: rgba(0,0,0,0);

        display: block;
      }

      *, *:before, *:after {
        box-sizing: inherit;
      }

      .date-container > iron-icon,
      .capacity-container > iron-icon,
      .site-container > iron-icon,
      .floor-container > iron-icon,
      .types-container > iron-icon {
        margin-top: 5px;
      }
      div.more-options-container > paper-button {
        color: #737373;
        border-bottom: 1px solid #ddd;
        height: 64px;
        margin: 0;
        padding: calc(64px / 2 - 19px / 2) 24px;
        text-align: left;
        width: 100%;
      }
      div.date-container > iron-icon.date-icon,
      div.types-container > iron-icon.types-icon {
        margin-top: 10px;
      }

      .search-item {
        min-height: 64px;
        padding: 16px 16px 16px 24px;
        border-bottom: 1px solid #ddd;
        @apply(--layout-horizontal);
        @apply(--layout-flex-auto);
      }
      .item-data-column {
        @apply(--layout-vertical);
      }
      .item-data-column {
        font-size: 85%;
        margin-left: 16px;
        @apply(--layout-flex-auto);
      }

      /* date-container */
      .all-day-row, .from-date-row, .to-date-row {
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }
      .all-day-row {
        margin: 11px 16px 16px;
      }
      .all-day-row > paper-toggle-button {
        --paper-toggle-button-checked-button-color: #1ddb8b;
        --paper-toggle-button-checked-bar-color: #1ddb8b;
        --paper-toggle-button-checked-ink-color: #1ddb8b;
      }
      paper-toggle-button.all-day-toggle,
      paper-button.from-time-button,
      paper-button.to-time-button {
        margin-left: auto;
      }

      .capacity-button,
      .site-button,
      .floor-button {
        font-size: 85%;
        margin-left: 24px;
      }

      .types-column {
        margin: 16px 16px 0 32px;
      }

      paper-checkbox {
        display: block;
        margin-bottom: 16px;
        --paper-checkbox-checked-color: #1ddb8b;
        --paper-checkbox-checked-ink-color: #1ddb8b;
        --paper-checkbox-unchecked-ink-color: #1ddb8b;
      }

      /* send-button */
      paper-button.send-button {
        max-width: 96px;
        margin: 24px auto;
        color: #1ddb8b;
        background-color: #fcfcfc;
        @apply(--layout-horizontal);
        @apply(--layout-center-center);
      }
      paper-button.send-button > iron-icon {
        margin-left: 8px;
      }

      /* addSiteDialog, addFloorDialog */
      paper-dialog {
        font-size: 12px;
        box-shadow: none;
      }
      paper-dialog#addSiteDialog paper-radio-button,
      paper-dialog#addFloorDialog paper-radio-button {
        width: 100%;
        --paper-radio-button-checked-color: #1ddb8b;
        --paper-radio-button-checked-ink-color: #1ddb8b;
      }
      paper-dialog#addFloorDialog paper-radio-button:last-of-type {
        margin-bottom: 16px;
      }

      paper-dialog#addSiteDialog > paper-dialog-scrollable,
      paper-dialog#addFloorDialog > paper-dialog-scrollable {
        --paper-dialog-scrollable: {
          max-width: 240px;
        };
      }

      paper-button {
        -webkit-tap-highlight-color: rgba(0,0,0,0);
      }

      p > paper-input,
      paper-dropdown-menu {
        --paper-input-container-focus-color: #1ddb8b;
      }
      .buttons > paper-button {
        color: #1ddb8b;
      }

      /* all-da-toggle */
      .all-day-hide-time {
        display: none;
      }

      /*response dialog mixins*/
      paper-dialog#responseDialog {
        margin: 0;
        left: 0;
        right: 0;
        width: 100%;
        height: 100%;
      }
      paper-dialog#responseDialog::content > *:first-child,
      paper-dialog#responseDialog::content > *:last-child {
        margin-top: 0;
        margin-bottom: 0;
      }
      paper-dialog#responseDialog paper-icon-button {
        font-size: 0;
      }
      paper-dialog#responseDialog .response-toolbar {
        height: 48px;
        padding: 0 16px;
        position: relative;
        font-size: 20px;
        @apply(--layout-center);
        @apply(--layout-horizontal);
        pointer-events: none;
      }
      paper-dialog#responseDialog .response-toolbar > * {
        pointer-events: auto;
      }
      paper-dialog#responseDialog .response-toolbar > [bottom-item] {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
      }

      /*response dialog extra mixins*/
      paper-dialog#responseDialog .response-title {
        margin-left: 8px;
      }
      paper-dialog#responseDialog .response-toolbar {
        background-color: #009688;
        color: #fff;
      }
      paper-dialog#responseDialog .response-container {
        @apply(--layout-fit);
        margin-top: calc(48px + 48px + 48px + 8px);
        overflow-y: auto;
      }
      paper-dialog#responseDialog .response-content {
        overflow-y: auto;
        @apply(--layout-fit);
      }

      /* page transition between real pages and spinner */
      .response-container > paper-spinner-lite,
      iron-pages {
        will-change: opacity;
      }

      iron-pages {
        opacity: 0;
        -webkit-transition: opacity ease-in .4s;
        transition: opacity ease-in .4s;
      }
      iron-pages.finish-loading {
        opacity: 1;
      }

      .response-container > paper-spinner-lite {
        opacity: 1;
        -webkit-transition: opacity ease-in .2s;
        transition: opacity ease-in .2s;
      }
      .response-container > paper-spinner-lite.finish-loading {
        opacity: 0;
      }

      /*tabs related sytling*/
      .response-container > paper-spinner-lite {
        position: absolute;
        left: 50%;
        top: calc(16px + 16px);
        margin: -15px 0 0 -15px;
        --paper-spinner-color: #1ddb8b;
      }
      .empty-tab {
        padding: 24px;
        font-weight: bold;
        color: #bdbdbd;
        font-size: 20px;
        text-transform: capitalize;
        @apply(--layout-vertical);
        @apply(--layout-center);
      }
      .empty-tab > iron-icon {
        --iron-icon-width: 84px;
        --iron-icon-height: 84px;
        --iron-icon-fill-color: #bdbdbd;
        margin-bottom: 24px;
      }
      .result-tab {
        @apply(--layout-vertical);
      }
      .floor-tabs {
        background-color: #009688;
        color: #fff;
        width: 100%;
      }
      .floor-tab {
        width: 32px;
      }

      .room-on-each-floor {
        position: relative;
        border-bottom: 1px solid #ddd;
        cursor: pointer;
        height: 64px;
        -webkit-transition: all .2s cubic-bezier(0.22, 0.61, 0.36, 1);
        transition: all .2s cubic-bezier(0.22, 0.61, 0.36, 1);
        padding-left: 24px;
        @apply(--layout-horizontal);
        @apply(--layout-flex-auto);
      }
      paper-tabs {
        --paper-tabs-selection-bar-color: #FFFF8D;
        --paper-icon-button-ink-color: #FFFF8D;
      }
      paper-tab {
        /* tune paper-tab ripple opacity */
        --paper-tab-ink: rgba(255, 255, 141, 0.5);
      }
      paper-tab.iron-selected {
        color: #ffff8d;
      }
      .room-on-each-floor > .room-name {
        font-size: 16px;
        text-transform: capitalize;
        @apply(--layout-vertical);
        @apply(--layout-center-justified);
        @apply(--layout-flex-auto);
      }
      .room-on-each-floor > paper-icon-button {
        margin-left: 8px;
        @apply(--layout-self-center);
      }

      .room-info-container {
        @apply(--layout-vertical);
        @apply(--layout-flex-auto);
      }
      .room-info {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        margin-bottom: 16px;
      }
      .room-info:last-child {
        margin: 0;
      }
      .room-info > iron-icon {
        color: #212121;
        margin-right: 16px;
      }
      .room-info.room-info-types-col > iron-icon {
        margin: 16px 16px auto 0;
      }
      .room-info-types {
        margin-top: 16px;
        @apply(--layout-vertical);
      }

      /* roomDialog */
      paper-dialog#roomDialog div.loading-content {
        word-break: break-all;
        word-wrap: break-word;
        margin-bottom: 24px;
        @apply(--layout-horizontal);
        @apply(--layout-center-center);
      }
      paper-dialog#roomDialog div.loading-content > paper-spinner-lite{
        margin-right: 16px;
        --paper-spinner-color: #1ddb8b;
      }
      paper-dialog#roomDialog h2 {
        margin-top: 24px;
        text-transform: capitalize;
      }

      /* optionsDialog */
      paper-dialog#optionsDialog {
        overflow: initial !important;
        margin: 0;
        width: 100%;
        @apply(--layout-fixed-bottom);
      }
      paper-listbox {
        margin: 0;
        padding: 0;
      }
      paper-icon-item {
        color: #6A7180;
      }

      /* paper-input */
      paper-input {
        --paper-input-container-focus-color: #1ddb8b;
      }

      /* paper-toast warning */
      paper-toast.warning {
        background-color: #ff5252;
        color: #fff;
      }

      /* desktop mode */
      /*@media all and (min-width: 376px) {*/
      @media all and (min-width: 600px) {
        :host {
          background-color: #fff;
          margin: 16px auto;
          padding-bottom: 1px;
          min-width: 376px;
          width: calc(100% / 2 - 16px);
          max-width: 480px;
          /* @apply(--shadow-elevation-4dp); */
          box-shadow: 0 4px 5px 0 rgba(0, 0, 0, 0.14),
                      0 1px 10px 0 rgba(0, 0, 0, 0.12),
                      0 2px 4px -1px rgba(0, 0, 0, 0.4);
        }

        paper-dialog#responseDialog > div.no-padding > div.response-toolbar > paper-tabs{
          position: relative;
          right: auto;
        }

        paper-dialog#responseDialog > div.no-padding > div.response-container > iron-pages {
          min-height: 64px;
          margin: 0 auto 16px;
          min-width: 360px;
          width: calc(100% / 2 - 16px);
          max-width: 480px;
          /* @apply(--shadow-elevation-4dp); */
          box-shadow: 0 4px 5px 0 rgba(0, 0, 0, 0.14),
                      0 1px 10px 0 rgba(0, 0, 0, 0.12),
                      0 2px 4px -1px rgba(0, 0, 0, 0.4);
        }
        paper-dialog#responseDialog iron-pages > paper-spinner-lite {
          margin: 0 auto;
        }

        paper-dialog#optionsDialog {
          width: 360px;
          left: auto;
          right: auto;
        }
      }
    </style>

    <iron-ajax id="searchEmptyRoom"
      method="post"
      url="https://semafore.motss.koding.io/search/results"
      contentType="application/x-www-form-urlencoded"
      handle-as="json"
      last-response="{{_emptyRoomResult}}"
      on-response="_onResponse"></iron-ajax>

    <firebase-collection id="firebaseSearch" location="[[_searchUrl]]" on-firebase-value="_onFirebaseValue"></firebase-collection>

    <div class="date-container search-item">
      <iron-icon class="date-icon" icon="icons:query-builder"></iron-icon>
      <div class="date-column item-data-column">
        <div class="all-day-row">
          All-day
          <paper-toggle-button class="all-day-toggle" checked="{{_allDayToggle}}"></paper-toggle-button>
        </div>
        <div class="from-date-row">
          <paper-button on-tap="_addFromDate" on-transitionend="_addFromDate">[[_fromDate]]</paper-button>
          <paper-button id="fromTimeButton" class="from-time-button" on-tap="_addFromTime" on-transitionend="_addFromTime">[[_fromTime]]</paper-button>
        </div>
        <div class="to-date-row">
          <paper-button on-tap="_addToDate" on-transitionend="_addToDate">[[_toDate]]</paper-button>
          <paper-button id="toTimeButton" class="to-time-button" on-tap="_addToTime" on-transitionend="_addToTime">[[_toTime]]</paper-button>
        </div>
      </div>
    </div>

    <div class="site-container search-item">
      <iron-icon icon="icons:room"></iron-icon>
      <paper-button class="site-button" on-tap="_addSite" on-transitionend="_addSite">[[_site]]</paper-button>
    </div>

    <div class="floor-container search-item">
      <iron-icon icon="social:location-city"></iron-icon>
      <paper-button class="floor-button" on-tap="_addFloor" on-transitionend="_addFloor">[[_floor]]</paper-button>
    </div>

    <div class="more-options-container">
      <template is="dom-if" if="[[_isMoreOptionsOpened]]" restamp="true" strip-whitespace>
        <paper-button more-options on-tap="_addMoreOptions" on-transitionend="_addMoreOptions">more options</paper-button>
      </template>
      <template is="dom-if" if="[[!_isMoreOptionsOpened]]" restamp="true" strip-whitespace>
        <div class="capacity-container search-item">
          <iron-icon icon="social:person-add"></iron-icon>
          <paper-button class="capacity-button" on-tap="_addPerson" on-transitionend="_addPerson">[[_capacity]]</paper-button>
        </div>

        <div class="types-container search-item">
          <iron-icon class="types-icon" icon="icons:create"></iron-icon>
          <div class="types-column item-data-column" on-iron-change="_getWhatBeingChecked">
            <paper-checkbox data-checked="ar">Adjoining Room (Operable Wall)</paper-checkbox>
            <paper-checkbox data-checked="pb">Panaboard</paper-checkbox>
            <paper-checkbox data-checked="pca">Polycom CX100 (Audio)</paper-checkbox>
            <paper-checkbox data-checked="pcv">Polycom CX5000 (Video Conferencing)</paper-checkbox>
            <paper-checkbox data-checked="pj">Projector</paper-checkbox>
            <paper-checkbox data-checked="pcf">Projector Cable Faulty</paper-checkbox>
            <paper-checkbox data-checked="pf">Projector Faulty</paper-checkbox>
            <paper-checkbox data-checked="spf">Screen Projector Faulty</paper-checkbox>
            <paper-checkbox data-checked="sb">SmartBoard 800</paper-checkbox>
            <paper-checkbox data-checked="tp">Telepresence</paper-checkbox>
            <paper-checkbox data-checked="tv">TV</paper-checkbox>
            <paper-checkbox data-checked="wg">Writing Glass</paper-checkbox>
          </div>
        </div>
      </template>
    </div>

    <paper-button class="send-button" on-tap="_sendParams" on-transitionend="_sendParams">
      <span>send</span>
      <iron-icon icon="icons:send"></iron-icon>
    </paper-button>

    <template is="dom-if" if="[[_isPersonOpened]]" restamp="true" strip-whitespace on-dom-change="_hasPersonRendered">
      <paper-dialog id="addPersonDialog"
        with-backdrop
        auto-fit-on-attach
        no-auto-focus
        on-iron-overlay-closed="_manipulateDocumentScrolling">
        <h2>Add Person</h2>
        <p>
          numerum nec posse intrare
          <paper-input label="capacity" type="number" min="0" max="99" value="{{_inputCap::input}}" placeholder="1"></paper-input>
        </p>
        <div class="buttons">
          <paper-button dialog-dismiss>Cancel</paper-button>
          <paper-button dialog-confirm on-tap="_updateCapacity">ok</paper-button>
        </div>
      </paper-dialog>
    </template>

    <template is="dom-if" if="[[_isSiteOpened]]" restamp="true" strip-whitespace on-dom-change="_hasSiteRendered">
      <paper-dialog id="addSiteDialog" site
        with-backdrop
        auto-fit-on-attach
        no-auto-focus
        on-iron-overlay-closed="_manipulateDocumentScrolling">
        <paper-dialog-scrollable>
          <paper-radio-group class="no-padding" selected="{{_inputSite}}" on-paper-radio-group-changed="_onPaperRadioGroupChanged" attr-for-selected="name">
            <template is="dom-repeat" items="[[_allSites]]" index-as="index" strip-whitespace>
              <paper-radio-button name="[[item]]" dialog-confirm>[[item]]</paper-radio-button>
            </template>
          </paper-radio-group>
        </paper-dialog-scrollable>
      </paper-dialog>
    </template>
    <template is="dom-if" if="[[_isFloorOpened]]" restamp="true" strip-whitespace on-dom-change="_hasFloorRendered">
      <paper-dialog id="addFloorDialog" floor
        with-backdrop
        auto-fit-on-attach
        no-auto-focus
        on-iron-overlay-closed="_manipulateDocumentScrolling">
        <paper-dialog-scrollable>
          <paper-radio-group selected="{{_inputFloor}}" on-paper-radio-group-changed="_onPaperRadioGroupChanged" attr-for-selected="name">
            <template is="dom-repeat" items="[[_allFloors]]" index-as="index" strip-whitespace>
              <paper-radio-button name="[[item]]" disabled="[[_isDisabled(_site, item)]]" dialog-confirm>[[item]]</paper-radio-button>
            </template>
          </paper-radio-group>
        </paper-dialog-scrollable>
      </paper-dialog>
    </template>

    <template is="dom-if" if="[[_isFromDateOpened]]" restamp="true" strip-whitespace on-dom-change="_hasFromDateRendered">
      <jv-datepicker-dialog id="fromDate"
        with-backdrop
        disable-days="[0,6]"
        date="{{_fromDate}}"
        on-iron-overlay-closed="_manipulateDocumentScrolling"></jv-datepicker-dialog>
    </template>
    <template is="dom-if" if="[[_isToDateOpened]]" restamp="true" strip-whitespace on-dom-change="_hasToDateRendered">
      <jv-datepicker-dialog id="toDate"
        with-backdrop
        disable-days="[0,6]"
        date="{{_toDate}}"
        min-date="[[_fromDate]]"
        on-iron-overlay-closed="_manipulateDocumentScrolling"></jv-datepicker-dialog>
    </template>
    <template is="dom-if" if="[[_isFromTimeOpened]]" restamp="true" strip-whitespace on-dom-change="_hasFromTimeRendered">
      <compound-timepicker-dialog id="fromTime"
        with-backdrop
        time="{{_fromTime}}"
        time-format="24"
        on-iron-overlay-closed="_manipulateDocumentScrolling"></compound-timepicker-dialog>
    </template>
    <template is="dom-if" if="[[_isToTimeOpened]]" restamp="true" strip-whitespace on-dom-change="_hasToTimeRendered">
      <compound-timepicker-dialog id="toTime"
        with-backdrop
        time="{{_toTime}}"
        time-format="24"
        on-iron-overlay-closed="_manipulateDocumentScrolling"></compound-timepicker-dialog>
    </template>

    <template is="dom-if" if="[[_isResponseOpened]]" restamp="true" strip-whitespace on-dom-change="_hasResponseRendered">
      <paper-dialog id="responseDialog"
        auto-fit-on-attach
        no-auto-focus
        on-iron-overlay-closed="_manipulateDocumentScrolling">
        <div class="no-padding">
          <div class="response-toolbar">
            <paper-icon-button icon="icons:arrow-back" on-tap="_closeResponseDialog" on-transitionend="_closeResponseDialog"></paper-icon-button>
            <div class="response-title">Search Result</div>
          </div>
          <div class="response-toolbar" hidden$="[[_hideSiteToolbar]]">
            <paper-tabs selected="{{_selectedSiteTab}}" bottom-item id="siteTabs">
              <template is="dom-repeat" items="[[_computeSites(_emptyRoomResult)]]" index-as="index" strip-whitespace>
                <paper-tab>[[item]]</paper-tab>
              </template>
            </paper-tabs>
          </div>
          <div class="response-toolbar" hidden$="[[_hideSiteToolbar]]">
            <paper-tabs id="floorTabs" selected="{{_selectedFloorTab}}" scrollable class="floor-tabs">
              <template is="dom-repeat" items="[[_floorsOfSites]]" index-as="index" strip-whitespace>
                <paper-tab class="floor-tab">[[item]]</paper-tab>
              </template>
            </paper-tabs>
          </div>

          <div class="response-container" on-touchmove="_onTouchMove">
            <paper-spinner-lite class$="[[_computeLoadingCls(_isSpinnerLoading)]]" active></paper-spinner-lite>

            <iron-pages class$="[[_computeLoadingCls(_isSpinnerLoading)]]" selected="[[_loadSearchResult]]">
              <div class="result-tab">
                <template is="dom-repeat" items="[[_roomsOfFloors]]" index-as="index" strip-whitespace>
                  <div class="room-on-each-floor">
                    <div class="room-name" room-idx$="[[index]]" on-down="_onDownRoom" on-up="_onUpRoom">
                      [[item.room]]
                      <paper-ripple id$="roomRipple[[index]]"></paper-ripple>
                    </div>
                    <paper-icon-button icon="icons:more-vert" room-idx$="[[index]]" on-tap="_onVertTap"></paper-icon-button>
                  </div>
                </template>
              </div>

              <div class="empty-tab">
                <iron-icon icon="icons:error-outline"></iron-icon>
                Sorry, No matched result!
              </div>
            </iron-pages>
          </div>
        </div>
      </paper-dialog>
    </template>

    <template is="dom-if" if="[[_isRoomOpened]]" restamp="true" strip-whitespace>
      <paper-dialog id="roomDialog"
        with-backdrop
        modal="[[_isLoading]]"
        auto-fit-on-attach
        no-auto-focus
        on-iron-overlay-opened="_onIronOverlayOpened">
        <template is="dom-if" if="[[_isLoading]]" restamp="true" strip-whitespace>
          <h2>Reserve Room</h2>
          <paper-dialog-scrollable dialog-element="[[_roomScrollable]]">
            <template is="dom-if" if="[[!_isReserved]]" restamp="true" strip-whitespace>
              <div class="loading-content">
                <paper-spinner-lite active="[[_isLoading]]"></paper-spinner-lite>
                Processing request...
              </div>
            </template>

            <template is="dom-if" if="[[_isReserved]]" restamp="true" strip-whitespace>
              <paper-input label="Reserved by" placeholder="[[_reservedBy]]" value="{{_reservedBy}}"></paper-input>
              <paper-input label="Subject" placeholder="[[_reservedSubject]]" value="{{_reservedSubject}}"></paper-input>
              <paper-input label="Reservation time" disabled placeholder="[[_reservedTime]]"></paper-input>
            </template>
          </paper-dialog-scrollable>
          <template is="dom-if" if="[[_isReserved]]" restamp="true" strip-whitespace>
            <div class="buttons">
              <paper-button on-tap="_confirmReservationDetails">cancel</paper-button>
              <paper-button on-tap="_confirmReservationDetails">ok</paper-button>
            </div>
          </template>
        </template>

        <template is="dom-if" if="[[!_isLoading]]" restamp="true" strip-whitespace>
          <h2>[[_selectedRoomInfo.room]]</h2>
          <paper-dialog-scrollable dialog-element="[[_roomScrollable]]">
            <div class="room-info-container">
              <div class="room-info">
                <iron-icon icon="icons:room"></iron-icon>[[_selectedRoomInfo.site]]
              </div>
              <div class="room-info">
                <iron-icon icon="social:location-city"></iron-icon>[[_selectedRoomInfo.floor]]
              </div>
              <div class="room-info">
                <iron-icon icon="social:person-add"></iron-icon>[[_selectedRoomInfo.capacity]]
              </div>
              <div class="room-info room-info-types-col">
                <iron-icon icon="icons:create"></iron-icon>
                <div class="room-info-types" id="checkboxesInRoomDialog">
                  <template is="dom-repeat" items="[[_decodeTypes(_selectedRoomInfo.types)]]" index-as="index" strip-whitespace>
                    <paper-checkbox checked>[[item]]</paper-checkbox>
                  </template>
                </div>
              </div>
            </div>
          </paper-dialog-scrollable>
          <div class="buttons">
            <paper-button dialog-dismiss>Cancel</paper-button>
            <paper-button on-tap="_reserveRoom">Reserve</paper-button>
          </div>
        </template>
      </paper-dialog>
    </template>

    <template is="dom-if" if="[[_isOptionsOpened]]" restamp="true" strip-whitespace>
      <paper-dialog id="optionsDialog"
        with-backdrop
        no-auto-focus>
        <template is="dom-if" if="[[_isOptionsOpened]]" restamp="true" strip-whitespace>
          <paper-listbox selected="0">
            <paper-icon-item dialog-confirm on-tap="_reserveRoom">
              <iron-icon icon="icons:add-circle" item-icon></iron-icon>Reserve
            </paper-icon-item>
            <paper-icon-item dialog-confirm on-tap="_showRoomInfo">
              <iron-icon icon="icons:info" item-icon></iron-icon>Info
            </paper-icon-item>
            <paper-icon-item dialog-dismiss on-tap="_forceCloseOptions">
              <iron-icon icon="icons:close" item-icon></iron-icon>Close
            </paper-icon-item>
          </paper-listbox>
        </template>
      </paper-dialog>
    </template>

    <paper-toast id="reserveRoomToast" class="" text="[[_reserveRoomMsg]]"></paper-toast>
  </template>

</dom-module>

<script>
  var _notafulldate = new Date();
  var _notayear = _notafulldate.getFullYear();
  var _notamonth = _notafulldate.getMonth();
  var _notadate = _notafulldate.getDate();
  var _time = _notafulldate.toTimeString().slice(0, 5);
  var _sitesArray = ['Any Site','KLB - Tower 5','KLB - Tower 2A','SUITE'];
  var _floorsArray = ['Any Floor','Level 1','Level 2','Level 3','Level 3A','Level 5','Level 6',
    'Level 7','Level 8','Level 9','Level 10','Level 11','Level 12',];
  var _typesArray = ['ar','pb','pca','pcv','pj','pcf','pf','spf','sb','tp','tv','wg'];
  var _typesResult = [0,0,0,0,0,0,0,0,0,0,0,0];
  var _bodyTarget;
  var _roomTypes = ['Adjoining Room (Operable Wall)','Panaboard','Polycom CX100 (Audio)',
    'Polycom CX5000 (Video Conferencing)','Projector','Projector Cable Faulty',
    'Projector Faulty','Screen Projector Faulty','SmartBoard 800',
    'Telepresence','TV','Writing Glass Board'];
  var _floorsCode = ['','01level','02level','03level','04level','05level','06level',
    '07level','08level','09level','10level','11level','12level'];

  Polymer({

  is: 'semafloor-search-page',

  properties: {
    uid: String,

    _searchUrl: {
      type: String,
      value: '//semafloor-webapp.firebaseio.com'
    },

    _allDayToggle:  {
      type: Boolean,
      value: !1
    },
    _capacity: {
      type: Number,
      value: 1
    },
    _allFloors: {
      type: Array,
      value: function() {
        return [1];
      }
    },
    _allSites: {
      type: Array,
      value: function() {
        return [1];
      }
    },
    _inputFloor: {
      type: String,
      value: 'Any Floor'
    },
    _floor: {
      type: String,
      value: 'Any Floor'
    },
    _floors: {
      type: String,
      value: ''
    },
    _inputSite: {
      type: String,
      value: 'Any Site'
    },
    _site: {
      type: String,
      value: 'Any Site'
    },
    _sites: {
      type: String,
      value: ''
    },
    _inputCap: Number,
    _totalCap: {
      type: Array,
      value: function() {
        return _.fill(Array(99), 1);
      }
    },
    _toDate: {
      type: String,
      value: function() {
        return [
          _notayear,
          _.padStart(_notamonth + 1, 2, '0'),
          _.padStart(_notadate, 2, '0')
        ].join('-');
      }
    },
    _toTime: {
      type: String,
      value: function() {
        return _time;
      }
    },
    _fromDate: {
      type: String,
      value: function() {
        return [
          _notayear,
          _.padStart(_notamonth + 1, 2, '0'),
          _.padStart(_notadate, 2, '0')
        ].join('-');
      }
    },
    _fromTime: {
      type: String,
      value: function() {
        return _time;
      }
    },
    _types: String,
    _emptyRoomResult: Object,
    _resultSites: Array,
    // _resultFloors: Array,
    _selectedSiteTab: {
      type: Number,
      value: 0
    },
    _selectedFloorTab: {
      type: Number,
      value: 0
    },
    _floorsOfSites: Array,
    _roomsOfFloors: Array,
    _loadSearchResult: Number,
    _selectedRoomInfo: Object,
    _tapRipple: {
      type: Boolean,
      value: !1
    },
    _roomIdx: Number,
    _reserveRoomMsg: String,
    _hideSiteToolbar: {
      type: Boolean,
      value: !1
    },
    _skipComputeSelected: Boolean,
    _prevFloor: String,

    _isLoading: Boolean,
    _isReserved: Boolean,

    _roomReserved: Boolean,
    _roomReservedSuccessfully: Boolean,

    _userObject: Object,

    _reservedBy: String,
    _reservedSubject: String,
    _reservedTime: String,

    _datesArrayCopy: Array,

    _isPersonOpened: Boolean,
    _isFloorOpened: Boolean,
    _isSiteOpened: Boolean,
    _isFromDateOpened: Boolean,
    _isToDateOpened: Boolean,
    _isFromTimeOpened: Boolean,
    _isToTimeOpened: Boolean,
    _isResponseOpened: Boolean,
    _isRoomOpened: Boolean,
    _isOptionsOpened: Boolean,

    _isMoreOptionsOpened: {
      type: Boolean,
      value: !0
    },

    _isSpinnerLoading: {
      type: Boolean,
      value: !0
    },

    _readyToAddFromDate: Boolean,
    _hasFromDateRendered: Boolean,

    _readyToAddFromTime: Boolean,
    _hasFromTimeRendered: Boolean,

    _readyToAddToDate: Boolean,
    _hasToDateRendered: Boolean,

    _readyToAddToTime: Boolean,
    _hasToTimeRendered: Boolean,

    _readyToAddSite: Boolean,
    _hasSiteRendered: Boolean,

    _readyToAddFloor: Boolean,
    _hasFloorRendered: Boolean,

    _readyToAddMoreOptions: Boolean,
    _hasMoreOptionsRendered: Boolean,

    _readyToAddPerson: Boolean,
    _hasPersonRendered: Boolean,

    _readyToSendParams: Boolean,
    _hasResponseRendered: Boolean,

    _readyToCloseResponse: Boolean,

  },

  listeners: {
    'touchmove': '_onTouchMove',
    'down': '_resetDisableTap',
  },

  observers: [
    '_hideTime(_allDayToggle)',
    '_showFloorsInTab(_emptyRoomResult, _selectedSiteTab)',
    '_setPrevFloor(_selectedFloorTab)',
    '_showRoomsInTab(_emptyRoomResult, _selectedSiteTab, _selectedFloorTab)',
    '_updateSearchUrl(uid)',
    '_closeRoomDialogAfterLoading(_roomReserved)',
    '_proceedToReserveRoom(_isLoading)',
  ],

  // Element Lifecycle

  ready: function() {
  // `ready` is called after all elements have been configured, but
  // propagates bottom-up. This element's children are ready, but parents
  // are not.
  //
  // This is the point where you should make modifications to the DOM (when
  // necessary), or kick off any processes the element wants to perform.
  },

  attached: function() {
    // `attached` fires once the element and its parents have been inserted
    // into a document.
    //
    // This is a good place to perform any work related to your element's
    // visual state or active behavior (measuring sizes, beginning animations,
    // loading resources, etc).
    this.fire('search-page-attached');
  },

  detached: function() {
  // The analog to `attached`, `detached` fires when the element has been
  // removed from a document.
  //
  // Use this to clean up anything you did in `attached`.
  },

  // Element Behavior

  /**
  * The `semafloor-search-page-lasers` event is fired whenever `fireLasers` is called.
  *
  * @event semafloor-search-page-lasers
  * @detail {{sound: String}}
  */

  _onFirebaseValue: function(ev) {
    console.log(ev.detail.val());
    this.set('_userObject', ev.detail.val());
  },

  _addSite: function(ev) {
    this.debounce('_addSite', function() {
      var _type = ev.type;
      if (_type === 'tap') {
        this.set('_readyToAddSite', !0);
      }else {
        if (this._readyToAddSite) {
          this.set('_readyToAddSite', !1);
          this._manipulateDocumentScrolling('hidden');

          // dynamically generate sites inside dialog.
          if (this._allSites.length === 1) {
            this.set('_allSites', _sitesArray);
          }

          if (!this._isSiteOpened) {
            this.set('_isSiteOpened', !0);
          }else {
            this.async(function() {
              this.$$('#addSiteDialog').open();
            }, 1);
          }
        }
      }
      _target = null; _type = null;
    }, 1);
  },
  _hasSiteRendered: function(ev) {
    if (ev.target.if) {
      this.async(function() {
        this.$$('#addSiteDialog').open();
      }, 1);
    }
  },
  _addFloor: function(ev) {
    this.debounce('_addFloor', function() {
      var _type = ev.type;
      if (_type === 'tap') {
        this.set('_readyToAddFloor', !0);
      }else {
        if (this._readyToAddFloor) {
          this.set('_readyToAddFloor', !1);
          this._manipulateDocumentScrolling('hidden');

          // generate floors inside dialog dynamically.
          if (this._allFloors.length === 1) {
            this.set('_allFloors', _floorsArray);
          }

          if (!this._isFloorOpened) {
            this.set('_isFloorOpened', !0);
          }else {
            this.async(function() {
              this.$$('#addFloorDialog').open();
            }, 1);
          }
        }
      }
      _target = null; _type = null;
    }, 1);
  },
  _hasFloorRendered: function(ev) {
    if (ev.target.if) {
      this.async(function() {
        this.$$('#addFloorDialog').open();
      }, 1);
    }
  },
  _addMoreOptions: function(ev) {
    this.debounce('_addMoreOptions', function() {
      var _type = ev.type;
      if (_type === 'tap') {
        this.set('_readyToAddMoreOptions', !0);
      }else {
        if (this._readyToAddMoreOptions) {
          this.set('_readyToAddMoreOptions', !1);

          if (this._disableTap) {
            return;
          }

          this.set('_isMoreOptionsOpened', !1);
        }
      }
      _type = null;
    }, 1);
  },
  _addPerson: function(ev) {
    this.debounce('_addPerson', function() {
      var _type = ev.type;
      if (_type === 'tap') {
        this.set('_readyToAddPerson', !0);
      }else {
        if (this._readyToAddPerson) {
          this.set('_readyToAddPerson', !1);
          this._manipulateDocumentScrolling('hidden');

          if (!this._isPersonOpened) {
            this.set('_isPersonOpened', !0);
          }else {
            this.async(function() {
              this.$$('#addPersonDialog').open();
            }, 1);
          }
        }
      }
      _target = null; _type = null;
    }, 1);
  },
  _hasPersonRendered: function(ev) {
    if (ev.target.if) {
      this.async(function() {
        this.$$('#addPersonDialog').open();
      }, 1);
    }
  },
  _addFromDate: function(ev) {
    this.debounce('_addFromDate', function() {
      var _type = ev.type;
      if (_type === 'tap') {
        this.set('_readyToAddFromDate', !0);
      }else {
        if (this._readyToAddFromDate) {
          this.set('_readyToAddFromDate', !1);
          this._manipulateDocumentScrolling('hidden');

          if (!this._isFromDateOpened) {
            this.set('_isFromDateOpened', !0);
          }else {
            this.async(function() {
              this.$$('#fromDate').open();
            }, 1);
          }
        }
      }
      _target = null; _type = null;
    }, 1);
  },
  _hasFromDateRendered: function(ev) {
    if (ev.target.if) {
      this.async(function() {
        this.$$('#fromDate').open();
      }, 1);
    }
  },
  _addToDate: function(ev) {
    this.debounce('_addToDate', function() {
      var _type = ev.type;
      if (_type === 'tap') {
        this.set('_readyToAddToDate', !0);
      }else {
        if (this._readyToAddToDate) {
          this.set('_readyToAddToDate', !1);
          this._manipulateDocumentScrolling('hidden');

          if (!this._isToDateOpened) {
            this.set('_isToDateOpened', !0);
          }else {
            this.async(function() {
              this.$$('#toDate').open();
            }, 1);
          }
        }
      }
      _target = null; _type = null;
    }, 1);
  },
  _hasToDateRendered: function(ev) {
    if (ev.target.if) {
      this.async(function() {
        this.$$('#toDate').open();
      }, 1);
    }
  },
  _addFromTime: function(ev) {
    this.debounce('_addFromTime', function() {
      var _type = ev.type;
      if (_type === 'tap') {
        this.set('_readyToAddFromTime', !0);
      }else {
        if (this._readyToAddFromTime) {
          this.set('_readyToAddFromTime', !1);
          this._manipulateDocumentScrolling('hidden');

          if (!this._isFromTimeOpened) {
            this.set('_isFromTimeOpened', !0);
          }else {
            this.async(function() {
              this.$$('#fromTime').open();
            }, 1);
          }
        }
      }
      _target = null; _type = null;
    }, 1);
  },
  _hasFromTimeRendered: function(ev) {
    if (ev.target.if) {
      this.async(function() {
        this.$$('#fromTime').open();
      }, 1);
    }
  },
  _addToTime: function(ev) {
    this.debounce('_addToTime', function() {
      var _type = ev.type;
      if (_type === 'tap') {
        this.set('_readyToAddToTime', !0);
      }else {
        if (this._readyToAddToTime) {
          this.set('_readyToAddToTime', !1);
          this._manipulateDocumentScrolling('hidden');

          if (!this._isToTimeOpened) {
            this.set('_isToTimeOpened', !0);
          }else {
            this.async(function() {
              this.$$('#toTime').open();
            }, 1);
          }
        }
      }
      _target = null; _type = null;
    }, 1);
  },
  _hasToTimeRendered: function(ev) {
    if (ev.target.if) {
      this.async(function() {
        this.$$('#toTime').open();
      }, 1);
    }
  },
  _updateCapacity: function(ev) {
    this.set('_capacity', this._inputCap || 1);
  },
  _updateSite: function() {
    var _site = _.indexOf(_sitesArray, this._inputSite);
    if (_site < 0) {
      this.set('_floor', 'Any Floor');
      this.set('_floors', '');
      this.set('_inputFloor', 'Any Floor');
      this.set('_sites', '');
      this.set('_site', 'Any Site');
      return;
    }

    var _siteCode = ['', 'alpha', 'beta', 'gamma'][_site];
    var _floor = (_siteCode === '' || _siteCode === 'alpha') ? 'Any Floor' :
    (_siteCode === 'gamma' ? 'Level 1' : 'Level 3');
    // automatically update `floors` when `sites` is updated.
    this.set('_floor', _floor);
    this.set('_floors', _floor === 'Any Floor' ? '' : (_siteCode === 'gamma' ? '01level' : '03level'));
    this.set('_inputFloor', _floor);
    // update `site`.
    this.set('_sites', _siteCode);
    this.set('_site', this._inputSite);
  },
  _updateFloor: function() {
    var _floor = _.indexOf(_floorsArray, this._inputFloor);
    if (_floor < 0) {
      this.set('_floors', '');
      this.set('_floor', 'Any Floor');
      return;
    }

    this.set('_floors', _floorsCode[_floor]);
    this.set('_floor', this._inputFloor);
  },

  _isDisabled: function(_site, _item) {
    function _updateMenu(_site) {
      // set `floors` on first time use;
      var _floor = _site === 'any' ? 'Any Floor' :
      (_site === 'suite' ? 'Level 1' : 'Level 3');
      if (_site === 'any') {
        this.set('_floor', 'Any Floor');
        this.set('_floors', '');
        this.set('_inputFloor', 'Any Floor');
        return _item !== 'Any Floor';
      }else {
        var _disabled = _item === _floor || _item === 'Any Floor';
        if (_disabled) {
          this.set('_floor', _floor);
          this.set('_inputFloor', _floor);
          this.set('_floors', _floor);
        }
        return !_disabled;
      }
    }

    switch (_site) {
      case 'KLB - Tower 2A':
        return _updateMenu.call(this, '2atower');
      break;
      case 'SUITE':
        return _updateMenu.call(this, 'suite');
      break;
      case 'Any Site':
        return _updateMenu.call(this, 'any');
      default:
        //  console.log('any floor for any site.');
        return !1;
    }
  },

  _hideTime: function(_toggle) {
    this.toggleClass('all-day-hide-time', _toggle, this.$.fromTimeButton);
    this.toggleClass('all-day-hide-time', _toggle, this.$.toTimeButton);
  },

  // get which `paper-checkbox` being checked or unchecked.
  _getWhatBeingChecked: function(ev) {
    var _target = ev.target;

    if (_target && _target.tagName === 'PAPER-CHECKBOX') {
      if (_target.hasAttribute('data-checked')) {
        var _chk = _target.getAttribute('data-checked');
        var _toggle = _target.checked;
        var _typeIdx = _.indexOf(_typesArray, _chk);
        var _typesBin, _typesHex;

        // modify value on corresponding index.
        _typesResult[_typeIdx] = +_toggle;

        // convert array into binary String then into HEX.
        _typesBin = _typesResult.join('');
        _typesHex = parseInt(_typesBin, 2).toString(16);

        // save final result.
        this._types = _typesHex;
      }
    }
  },

  // aggregate all inputs before sending it out as request.
  _sendParams: function(ev) {
    this.debounce('_sendParams', function() {
      var _type = ev.type;
      if (_type === 'tap') {
        this.set('_readyToSendParams', !0);
      }else {
        if (this._readyToSendParams) {
          var _params = '';
          var _allDayToggle = this._allDayToggle;
          var _fromTime = _allDayToggle ? '08:00' : this._fromTime;
          var _toTime = _allDayToggle ? '23:30' : this._toTime;
          var _fromDate = this._fromDate;
          var _toDate = this._toDate;
          var _incorrectTime = _fromTime > _toTime || _fromTime < '08:00' || _toTime > '23:30';
          var _incorrectDate = new Date(_fromDate) > new Date(_toDate);
          var _reserveRoomToast = this.$.reserveRoomToast;

          // console.log(_fromTime < '08:00', _toTime > '23:30', _fromTime, _toTime);
          this.set('_readyToSendParams', !1);

          // Check date and time before parsing.
          if (_incorrectTime || _incorrectDate) {
            var _errorMsg = 'Incorrect Date/ Time! Please ensure starting date/ time is always smaller.';

            if (_fromTime < '08:00' || _toTime > '23:30') {
              _errorMsg = 'Please select any time in between 08:00 and 23:30.';
            }
            _reserveRoomToast.classList.add('warning');
            this.set('_reserveRoomMsg', _errorMsg);
            console.warn('Incorrect Date/ Time!');
            if (_reserveRoomToast.opened) {
              _reserveRoomToast.close();
            }
            this.async(function() {
              _reserveRoomToast.open();
            }, 1);
            return;
          }else {
            _reserveRoomToast.classList.remove('warning');
          }

          _params = 'startDate=' + encodeURIComponent(this._fromDate) + '&' +
                    'endDate=' + encodeURIComponent(this._toDate) + '&' +
                    'tStart=' + encodeURIComponent(_fromTime) + '&' +
                    'tEnd=' + encodeURIComponent(_toTime) + '&' +
                    'capacity=' + encodeURIComponent(this._capacity) + '&' +
                    'site=' + encodeURIComponent(this._sites) + '&' +
                    'floor=' + encodeURIComponent(this._floors) + '&' +
                    'types=' + encodeURIComponent(this._types || 0);

          console.log(_params);
          this.$.searchEmptyRoom.body = _params;
          this.$.searchEmptyRoom.generateRequest();
          // Reset _isLoading here is much safer before opening the responseDialog.
          this.set('_isLoading', !1);
          this.set('_isReserved', !1);
          // Reset _roomReserved here is much safer before opening the responseDialog.
          if (this._roomReserved) {
            this.set('_roomReserved', !1);
            this.set('_roomReservedSuccessfully', !1);
          }

          this._manipulateDocumentScrolling('hidden');
          if (!this._isResponseOpened) {
            this.set('_isResponseOpened', !0);
          }else {
            this.async(function() {
              this.$$('#responseDialog').open();
            }, 1);
          }
        }
      }
    }, 1);
  },
  _hasResponseRendered: function(ev) {
    if (ev.target.if) {
      this.async(function() {
        this.$$('#responseDialog').open();
      }, 1);
    }
  },

  _onResponse: function(ev) {
    // check if return result is empty OR contains no room (totoalEmptyRooms : 0);
    var _isEmpty = this._isEmptyResultEmpty(this._emptyRoomResult);
    this.set('_skipComputeSelected', _isEmpty);
    this.set('_hideSiteToolbar', _isEmpty);

    this.set('_isSpinnerLoading', !1);
    this.set('_loadSearchResult', _isEmpty ? 1 : 0);
  },

  _isEmptyResultEmpty: function(_emptyRoomResult) {
    return _.isEmpty(_emptyRoomResult);
  },

  _closeResponseDialog: function(ev) {
    this.debounce('_closeResponseDialog', function() {
      var _type = ev.type;
      if (_type === 'tap') {
        this.set('_readyToCloseResponse', !0);
      }else {
        if (this._readyToCloseResponse) {
          this.set('_readyToCloseResponse', !1);

          // reset _selectedSiteTab, _selectedFloorTab when closing responseDialog;
          this.set('_selectedSiteTab', 0);
          this.set('_selectedFloorTab', 0);
          // reset _loadSearchResult, _emptyRoomResult when closing responseDialog;
          this.set('_isSpinnerLoading', !0);
          this.set('_emptyRoomResult', null);

          this.async(function() {
            this._manipulateDocumentScrolling();
            this.$$('#responseDialog').close();
          }, 1);
        }
      }
    }, 1);
  },

  _computeSites: function(_emptyRoomResult) {
    var _siteKeys = _.keys(_emptyRoomResult);
    var _keysName = ['', 'alpha', 'beta', 'gamma'];
    _siteKeys = _siteKeys.filter(function(_key) {
      return _key === 'alpha' || _key === 'beta' || _key === 'gamma';
    });
    this._computeFloors(_siteKeys, _emptyRoomResult);
    _siteKeys = _siteKeys.map(function(_key) {
      return _sitesArray[_keysName.indexOf(_key)];
    });
    this.set('_resultSites', _siteKeys);
    return _siteKeys;
  },

  _computeFloors: function(_siteKeys, _emptyRoomResult) {
    var _floorKeys = [];
    for (var i = 0; i < _siteKeys.length; i++) {
      _floorKeys.push(_.keys(_emptyRoomResult[_siteKeys[i]]));
    }
    this.set('_resultFloors', _floorKeys);
  },

  _setPrevFloor: function(_selectedFloorTab) {
    if (this._selectedSiteTab === 0) {
      this.set('_prevFloor', _selectedFloorTab);
    }
  },

  _showFloorsInTab: function(_emptyRoomResult, _selectedSiteTab) {
    // skip this function if return result is empty;
    if (this._isEmptyResultEmpty(_emptyRoomResult)) {
      return;
    }

    var _floorsNumber = [
    '', '1', '2', '3', '3A', '5', '6', '7', '8', '9', '10', '11', '12'];
    var _siteKeys = _.keys(_emptyRoomResult);
    var _newFloors = _.keys(_emptyRoomResult[_siteKeys[_selectedSiteTab]]);
    var _newFloors = _newFloors.map(function(n) {
      return _floorsNumber[_floorsCode.indexOf(n)];
    });
    // workaround: to fix #selectionBar of paper-tabs to show properly;
    // notifyResize() on site tabs and floor tabs;
    if (_selectedSiteTab === 0) {
      this.set('_selectedFloorTab', this._prevFloor);
    }else {
      this.set('_selectedFloorTab', 0); // for beta and gamma, only 1 floor.
    }
    this.debounce('resizeTabs', function() {
      this.$$('#siteTabs').notifyResize();
      this.$$('#floorTabs').notifyResize();
    });

    this.set('_floorsOfSites', _newFloors);
  },

  _showRoomsInTab: function(_emptyRoomResult, _selectedSiteTab, _selectedFloorTab) {
    // skip this function if return result is empty;
    if (this._isEmptyResultEmpty(_emptyRoomResult)) {
      return;
    }

    var _newSite = _.keys(_emptyRoomResult)[_selectedSiteTab];
    var _newFloor = _.keys(_emptyRoomResult[_newSite])[_selectedFloorTab];
    _newFloor = _emptyRoomResult[_newSite][_newFloor];
    // workaround: to fix #selectionBar of paper-tabs to show properly;
    // notifyResize() on site tabs and floor tabs;
    this.debounce('resizeTabs', function() {
      this.$$('#siteTabs').notifyResize();
      this.$$('#floorTabs').notifyResize();
    });

    this.set('_roomsOfFloors', _newFloor);
  },

  _onDownRoom: function(ev) {
    var _target = ev.target;
    while (_target && _target.tagName !== 'DIV') {
      _target = _target.parentElement;
    }
    if (_target) {
      this.set('_disableTap', !1);
      this.set('_tapRipple', !0);
      // compute and save room info;
      this.set('_roomIdx', _target.getAttribute('room-idx'));
      this.set('_selectedRoomInfo', ev.model.item);
    }
  },

  _onUpRoom: function(ev) {
    if (this._disableTap) {
      this.set('_tapRipple', !1);
      return;
    }

    if (!this._isRoomOpened) {
      this.set('_isRoomOpened', !0);
      // Tell dialog scrollable its parent dialog since they're inside a template.
      this.set('_roomScrollable', this.$$('#roomDialog'));
    }

    // workaround: 300ms to mimic the effect of transitionend as if the dialog waits until the ripple fades out.
    this.async(function() {
      this.$$('#roomDialog').open();
      // workaround: to display backdrop in nested dialog;
      // document.body.querySelector('iron-overlay-backdrop').style.zIndex = 103;
    }, 300);
  },

  _onTouchMove: function(ev) {
    // End ripple effect on moreOptions button.
    if (ev.target.tagName === 'PAPER-BUTTON') {
      var _target = ev.target;
      if (_target.tagName === 'PAPER-BUTTON') {
        if (_target.hasAttribute('more-options')) {
          var _ripple = _target.getRipple();
          this.set('_disableTap', !0);
          _ripple.upAction();
        }
      }
    }

    if (!this._tapRipple) {
      return;
    }

    // End ripple animation loop during scrolling...
    if (!this._disableTap) {
      this.set('_disableTap', !0);
      this.$$('#roomRipple' + this._roomIdx).upAction();
    }
  },
  _resetDisableTap: function(ev) {
    if (ev.target.tagName === 'PAPER-BUTTON') {
      if (ev.target.hasAttribute('more-options')) {
        this.set('_disableTap', !1);
      }
    }
  },

  _onVertTap: function(ev) {
    var _target = ev.target;
    while (_target && _target.tagName !== 'PAPER-ICON-BUTTON') {
      _target = _target.parentElement;
    }
    this.set('_roomIdx', _target.getAttribute('room-idx'));
    this.set('_selectedRoomInfo', ev.model.item);

    if (!this._isOptionsOpened) {
      this.set('_isOptionsOpened', !0);
    }

    this.async(function() {
      this._setAnimationConfigToOptionsDialog();
      this.$$('#optionsDialog').open();
    }, 300);
  },

  /* jshint ignore:start */
  /* jscs:disable requireCamelCaseOrUpperCaseIdentifiers */
  _reserveRoom: function(ev) {
    console.log(this._selectedRoomInfo);
    console.log(this._fromDate, this._toDate, this._fromTime, this._toTime, this._allDayToggle);
    this._forceCloseOptions();

    // Set _isLoading to block further user interaction while loading Firebase.
    // Then the Observer will trigger method _transactionWithReservations once _isLoading is truthy.
    this.set('_isLoading', !0);
    this.async(function() {
      this.$$('#roomDialog').notifyResize();
    }, 1);
  },
  // 0800 0830 | 0830 0900 | 0900 0930 | 0930 1000
  //    1    X |    1    X |    1    X |    1    X
  // 0800 0830 0900 | 0900 0930 1000 |
  //    1    1    X |    1    1    X |
  // 0800 0830 0900 0930 | 0930 1000 1030 1100 |
  //    1    1    1    X |    1    1    1    X |
  _computeTimeDec: function(_fromTime, _toTime, _allDayToggle) {
    var _timeBin;
    // if it's all day, all is 1s.
    if (_allDayToggle) {
      _timeBin = _.fill(Array(32), 1).join('');
      return parseInt(_timeBin, 2).toString(10);
    }
    // convert time string into index.
    function _timeToIdx(_timeInMin) {
      return Math.floor((_timeInMin - 480) / 30);
    }
    // convert time into minutes.
    function _timeToMin(_time, _isToTime) {
      var _hours = parseInt(_time.slice(0, 2));
      var _minutes = parseInt(_time.slice(-2));
      return _isToTime ? (_hours * 60 + _minutes - 1) : (_hours * 60 + _minutes);
    }

    var _fromTimeInMin = _timeToMin(_fromTime);
    var _toTimeInMin = _timeToMin(_toTime, !0);
    var _startPos = _timeToIdx(_fromTimeInMin);
    var _timeLength = _timeToIdx(_toTimeInMin) + 1;
    _timeBin = _.fill(_.fill(Array(32), 0), 1, _startPos, _timeLength).join('');

    return parseInt(_timeBin, 2).toString(10);
  },
  _transactionWithReservations: function(_fromDate, _toDate, _timeDec, _selectedRoomInfo) {
    // TODO: Steps:
    // X) update room time.
    // X) update global reservation list so that current reservations will be updated.
    // X) update user's reservation list.

    var _monthNames = ['january', 'february', 'march', 'april', 'may', 'june',
      'july', 'august', 'september', 'october', 'november', 'december'];
    var _fd = _fromDate;
    var _td = _toDate;
    var _totalDays = (+new Date(_td) - +new Date(_fd)) / 86400000 + 1;
    var _sd = new Date(_fromDate);
    var _sdfy = _sd.getFullYear();
    var _sdm = _sd.getMonth();
    var _sdd = _sd.getDate();
    // Get week number from date.
    function getWeek(_date) {
      var _now = new Date(_date);
      _now = new Date(_now.getFullYear(), _now.getMonth(), _now.getDate() - _now.getDay() + 4);
      var onejan = new Date(_now.getFullYear(), 0, 1);
      return Math.ceil(((_now - onejan) / 86400000 + 1) / 7);
    }
    // Compute AND-ed or OR-ed timeHex and return the result to Firebase.
    function _updateData(_timeHex, _maskDec) {
      var _timeDec = parseInt(_timeHex, 16).toString(10);
      var _result = parseInt((_timeDec | _maskDec) >>> 0, 10).toString(16);

      return _result;
    }
    // siteNameToCode
    function _siteNameToCode(_siteName) {
      var _siteIdx = _sitesArray.indexOf(_siteName);
      return ['', 'alpha', 'beta', 'gamma'][_siteIdx];
    }
    // floorNameToCode
    function _floorNameToCode(_floorName) {
      var _floorIdx = _floorsArray.indexOf(_floorName);
      return _floorsCode[_floorIdx];
    }
    // monthNameToCode
    function _monthNameToCode(_date) {
      var _mm = _date.getMonth();
      return ('0' + _mm).slice(-2) + _monthNames[_mm];
    }

    var _datesArray = [];
    // Date array.
    // X - TODO: To update room time for one or more dates.
    // Firebase ref to a room, KLB - Tower 5, Level 1, Taipei 101 on 2016-01-29:
    // ref - //polymer-semaphore.firebaseio.com/mockMessages/
    // year - /2016
    // month - /00january
    // week - /week05
    // day - /29
    // site, level, room - /site/alpha/01level/taipei101
    // time - /time
    //
    // given params to compute date and time:
    // fromDate - this._fromDate
    // toDate - this._toDate
    // tStart - this._fromTime
    // tEnd - this._toTime
    // allDayToggle - this._allDayToggle (08:00 - 23:30)
    // site - this._sites (not needed as at this point it's empty)
    // floor - this._floors (not needed as at this point it's empty)
    // capacity - this._capacity (not needed)
    // types - this._types (not needed)
    //
    // To compute date array and strip all weekends:
    for (var i = 0, _cd, _cdfy, _cdm, _cdm1, _cdd, _cdw, _cday; i < _totalDays; i++) {
      _cd = new Date(_sdfy, _sdm, _sdd + i);
      _cday = _cd.getDay();
      if (_cday > 0 && _cday < 6) {
        _cdfy = _cd.getFullYear();
        _cdm1 = _cd.getMonth();
        _cdm = _monthNameToCode(_cd);
        _cdd = ('0' + _cd.getDate()).slice(-2);
        _cd = [_cdfy, _cdm1 + 1, _cdd].join('-');
        _cdw = getWeek(_cd);
        _cdw = 'week' + ('0' + _cdw).slice(-2);
        _datesArray.push({
          y: _cdfy,
          m: _cdm,
          w: _cdw,
          d: _cdd,
          f: _cd,
          day: _cday
        });
      }
    }
    // console.log(_datesArray);
    // Dates array with URL.
    // capacity: 4
    // floor: "01level"
    // room: "twin towers"
    // site: "alpha"
    // time: "0"
    // types: "803"
    // Now new url will be:
    //
    // ref - //polymer-semaphore.firebaseio.com/mockMessages/
    // year - /2016
    // month - /00january
    // week - /week05
    // day - /29
    // site, level, room - /site/alpha/01level/taipei101
    // time - /time
    var _ref = '//polymer-semaphore.firebaseio.com/mockMessages';
    var _siteToCode = _siteNameToCode(_selectedRoomInfo.site);
    var _floorToCode = _floorNameToCode(_selectedRoomInfo.floor);
    var _site = ['site', _siteToCode, _floorToCode, _selectedRoomInfo.room].join('/');
    var _retryDates = [];
    var _that = this;
    // var _searchUrl = this._searchUrl;

    var _datesArrayWithPromise = _datesArray.map(function(_date) {
      var _eachRef = new Firebase([_ref, _date.y, _date.m, _date.w, _date.d, _site].join('/'));
      console.log(_eachRef);
      return _eachRef.child('time').once('value').then(function(_snapshot) {
        return _eachRef.child('time').transaction(function(_data) {
          if (_data === null) {
            console.warn("Firebase Promise's status: pending");
            return parseInt(_timeDec, 10).toString(16);
          }else {
            var _dataDec = parseInt(_data, 16).toString(10);
            var _slotNotTakenYet = ((_dataDec & _timeDec) >>> 0) === 0;
            if (_slotNotTakenYet) {
              return _updateData(_data, _timeDec);
            }
            return;
          }
        });
      });
    });
    // Return results of all Promises of all dates.
    Promise.all(_datesArrayWithPromise).then(function(snapshot) {
      var _allCommitted = snapshot.every(function(n) {
        console.log('Added is committed: ', n.committed);
        console.log('committed value: ', n.snapshot.val());
        return n.committed === !0;
      });
      // If one of them is not committed, retry is needed.
      // TODO: Retry failed Promise.
      if (!_allCommitted) {
        snapshot.forEach(function(n) {
          // Push ref of uncommitted dates.
          if (!n.committed) {
            var snapref = n.snapshot.ref();
            _retryDates.push(snapref);
          }
        });
        console.log(_retryDates);
      }

      return _allCommitted;
    }).then(function(_allCommitted) {
      var _committedDate = new Date();
      var _committedFullYear = new Date().getFullYear();
      var _committedMonth = _monthNameToCode(_committedDate);
      var _committedRef = [_committedFullYear, _committedMonth, 'commitHistory'].join('/');
      var _committedQuery = _that.$.searchEmptyRoom.body;
      var _allDayToggle = _that._allDayToggle;
      var _fromTime = _allDayToggle ? '08:00' : _that._fromTime;
      var _toTime = _allDayToggle ? '23:30' : _that.toTime;
      var _displayName = _that._userObject.displayName;
      var _commitRef = new Firebase(_ref);
      // If all requests have committed, set _roomReserved to trigger Observer to close dialog.
      if (_allCommitted) {
        // TODO: Before setting _roomReserved to trigger closing dialogs.
        // Show dialog to ask user to change reservations details, eg title, objectives, etc.
        // This is required for subsequent operation to save all these committed reservations into
        // global reserve list which is needed for current reservation!

        // Push successful commits into history.
        _commitRef.child(_committedRef).push({
          timestamp: Firebase.ServerValue.TIMESTAMP,
          date: _committedDate.toString(),
          query: _committedQuery,
          allCommitted: _allCommitted
        });
      }else {
        // TODO: Revert all committed changes in Firebase once failed.
        // _that._revertCommittedChanges()

        // Push committed failures into history.
        return _commitRef.child(_committedRef).push({
          timestamp: Firebase.ServerValue.TIMESTAMP,
          date: _committedDate.toString(),
          query: _committedQuery,
          allCommitted: _allCommitted,
          reason: _retryDates
        });
      }

      // Set if succeeded.
      _that.set('_roomReservedSuccessfully', _allCommitted);

      // Allow user to fill in reservation details after all committed is !0.
      // Save needed copy to properties.
      _that.set('_datesArrayCopy', _datesArray);
      _that.set('_reservedBy', _displayName);
      _that.set('_reservedSubject', 'meeting');
      _that.set('_reservedTime', [_fromTime, _toTime].join(' - '));
      // Set to trigger switching to fill in details.
      _that.set('_isReserved', !0);
      // Center content-changed dialog.
      _that.async(function() {
        _that.$$('#roomDialog').notifyResize();
      }, 1);
      console.log(_datesArray);
      // return _allCommitted;
    }).catch(function(error) {
      console.warn(error);
    });
  },
  /* jshint ignore:end */
  /* jscs:enable requireCamelCaseOrUpperCaseIdentifiers */

  _showRoomInfo: function(ev) {
    console.log(ev, this._selectedRoomInfo);
    this._forceCloseOptions();

    if (!this._isRoomOpened) {
      this.set('_isRoomOpened', !0);
    }

    this.async(function() {
      this.$$('#roomDialog').open();
    }, 1);
  },

  _decodeTypes: function(_types) {
    var _hexTypes = _.padStart(parseInt(_types, 16).toString(2), 12, 0);
    var _str2arr = _hexTypes.split('').map(Number);
    var _filtered = [];
    _.filter(_str2arr, function(el, idx) {
      if (el === 1) _filtered.push(_roomTypes[idx]);
    });
    _hexTypes = null; _str2arr = null;
    return _filtered;
  },

  _onIronOverlayOpened: function(ev) {
    // workaround to iron-resize and refit dialog with paper-checkbox inside it;
    this.$$('#roomDialog').notifyResize();
  },

  _forceCloseOptions: function() {
    var _dialog = this.$$('#optionsDialog');
    if (_dialog && _dialog.opened) {
      _dialog.close();
    }
  },

  _onPaperRadioGroupChanged: function(ev) {
    var _target = ev.target;
    while (_target && _target.tagName !== 'PAPER-DIALOG') {
      _target = _target.parentElement;
    }

    if (_target && _target.hasAttribute('site')) {
      this._updateSite();
    }else {
      this._updateFloor();
    }
    _target.close();
  },

  _updateSearchUrl: function(_uid) {
    console.log(_uid);
    var _newUrl = '//semafloor-webapp.firebaseio.com/users/google/' + this.uid;
    this.set('_searchUrl', _newUrl);
  },

  _closeRoomDialogAfterLoading: function(_roomReserved) {
    // Observer keeps observing on the value change of _roomReserved.
    // However, we only interested in when the value is truthy.
    if (_roomReserved) {
      // Close roomDialog and responseDialog immediately.
      this.$$('#roomDialog').close();
      this.$$('#responseDialog').close();
      // Reset document body overflow scrolling.
      this._manipulateDocumentScrolling();
      // After 250ms of debounce rate, setting up the toast.
      this.debounce('closeResponseDialog', function() {
        var _toast = this.$.reserveRoomToast;
        var _capitalizedRoomName = _.map(_.words(this._selectedRoomInfo.room), function(n) {
          return _.capitalize(n);
        }).join(' ');
        var _msg = this._roomReservedSuccessfully ? _capitalizedRoomName + ' has been reserved successfully!' : 'Failed to reserve ' + _capitalizedRoomName + '. Please try again.';
        if (_toast.opened) {
          _toast.close();
        }
        this.set('_reserveRoomMsg', _msg);

        // Async-ly open toast.
        this.async(function() {
          _toast.open();
        }, 1);
      }, 250);
    }
  },

  _proceedToReserveRoom: function(_isLoading) {
    if (_isLoading) {
      // Proceed to reserve room.
      var _dialog = this.$$('#roomDialog');
      if (!_dialog.opened) {
        _dialog.open();
      }

      this.debounce('transactionWithReservations', function() {
        // TODO: This can only be completed once roomify-create in Node is completed!
        var _timeDec = this._computeTimeDec(this._fromTime, this._toTime, this._allDayToggle);

        this._transactionWithReservations(this._fromDate, this._toDate, _timeDec, this._selectedRoomInfo);
      }, 250);
    }
  },

  // Push reservations details into Firebase.
  _pushReservationDetails: function(_datesArray, _ref, _that, _fromTime, _toTime) {
    var _selectedRoomInfo = _that._selectedRoomInfo;
    // var _fromDate = _that._fromDate;
    // var _toDate = _that._toDate;
    // var _fromTime = _that._fromTime;
    // var _toTime = _that._toTime;
    var _dateString = new Date().toString();
    var _userObject = _that._userObject;

    var _datesArrayWithPromise = _datesArray.map(function(_date) {
      var _eachRef = new Firebase([_ref, _date.y, _date.m, _date.w, _date.d, 'reservations'].join('/'));
      return _eachRef.push({
        timestamp: Firebase.ServerValue.TIMESTAMP,
        person: _userObject.displayName || '',
        subject: _that._reservedSubject || '',
        date: _date.f,
        fromTime: _fromTime,
        toTime: _toTime,
        reservedDate: _dateString,
        roomInfo: _selectedRoomInfo
      });
    });

    return _datesArrayWithPromise;

    // Promise.all(_datesArrayWithPromise).then(function(_snapshot) {
    //   console.log('Saved to ' + [_fromDate, _toDate].join(' - ') + ' at ' + [_fromTime, _toTime].join(' - '));
    // }).catch(function(error) {
    //   console.warn(error);
    // });
  },
  _pushUserReservationDetails: function(_datesArray, _searchUrl, _that, _fromDate, _toDate, _fromTime, _toTime) {
    var _selectedRoomInfo = _that._selectedRoomInfo;
    // var _fromDate = _that._fromDate;
    // var _toDate = _that._toDate;
    // var _fromTime = _that._fromTime;
    // var _toTime = _that._toTime;
    var _dateString = new Date().toString();
    var _userObject = _that._userObject;

    var _datesArrayWithPromise = _datesArray.map(function(_date) {
      var _eachRef = new Firebase([_searchUrl, 'reservations'].join('/'));
      return _eachRef.push({
        timestamp: Firebase.ServerValue.TIMESTAMP,
        person: _userObject.displayName || '',
        subject: _that._reservedSubject || '',
        date: _date.f,
        fromTime: _fromTime,
        toTime: _toTime,
        reservedDate: _dateString,
        roomInfo: _selectedRoomInfo
      });
    });

    Promise.all(_datesArrayWithPromise).then(function(_snapshot) {
      console.log('Saved to ' + _searchUrl + ': ' + [_fromDate, _toDate].join(' - ') + ' at ' + [_fromTime, _toTime].join(' - '));
    }).then(function() {
      // At here, global reservations list and user reservations list are updated.
      // Can proceed to close all dialogs and show toast.
      _that.set('_roomReserved', !0);
    }).catch(function(error) {
      console.warn(error);
    });
  },
  // Allow user to confirm the reservation details with some default values before updating
  // global reservations list and user reservations list.
  _confirmReservationDetails: function(ev) {
    var _datesArrayCopy = this._datesArrayCopy;
    var _searchUrl = this._searchUrl;
    var _allDayToggle = this._allDayToggle;
    var _fromDate = this._fromDate;
    var _toDate = this._toDate;
    var _fromTime = _allDayToggle ? '08:00' : this._fromTime;
    var _toTime = _allDayToggle ? '23:30' : this._toTime;
    var _that = this;


    var _pushReservationDetailsWithPromise = this._pushReservationDetails(_datesArrayCopy, '//polymer-semaphore.firebaseio.com/mockMessages', _that, _fromTime, _toTime);
    var _pushUserReservationDetails = this._pushUserReservationDetails;

    Promise.all(_pushReservationDetailsWithPromise).then(function() {
      console.log('Saved to ' + [_fromDate, _toDate].join(' - ') + ' at ' + [_fromTime, _toTime].join(' - '));
    }).then(function() {
      _pushUserReservationDetails(_datesArrayCopy, _searchUrl, _that, _fromDate, _toDate, _fromTime, _toTime);
    }).catch(function(error) {
      console.warn(error);
    });

    // Set _isReserved to switch back to spinner.
    // Due to Promise is async, this can be done here right after Promise!
    this.set('_isReserved', !1);
    this.async(function() {
      this.$$('#roomDialog').notifyResize();
    }, 1);
  },

  _manipulateDocumentScrolling: function(_state) {
    var _overflow = typeof _state == 'object' ? '' : _state || '';

    document.body.style.overflow = _overflow;
  },

  _setAnimationConfigToOptionsDialog: function() {
    var _dialog = this.$$('#optionsDialog');
    _dialog.animationConfig = {
      'entry': {
        name: 'transform-animation',
        node: _dialog,
        transformFrom: 'translateY(100%)',
        transformTo: 'translateY(0)'
      },
      'exit': {
        name: 'transform-animation',
        node: _dialog,
        transformFrom: 'translateY(0)',
        transformTo: 'translateY(100%)'
      }
    };
  },

  _computeLoadingCls: function(_isSpinnerLoading) {
    return _isSpinnerLoading ? '' : 'finish-loading';
  },

  // X - TODO: set min-height when loading since at least 1 room must be shown on screen.
  // X - TODO: _manipulateDocumentScrolling FTW.
  // X - TODO: calculate width for all raised elements for desktop mode.
  // X - TODO: page transition between spinner and real pages.
  });
</script>
