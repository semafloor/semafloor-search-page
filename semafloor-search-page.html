<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="semafloor-search-page-theme.html">

<link rel="import" href="../jv-datepicker/jv-datepicker-dialog.html">
<link rel="import" href="../compound-timepicker/compound-timepicker-dialog.html">

<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icons/social-icons.html">

<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-toggle-button/paper-toggle-button.html">

<script src="../lodash/lodash.min.js" charset="utf-8"></script>

<!--
An element providing a solution to no problem in particular.

Example:

    <semafloor-search-page></semafloor-search-page>

@group Seed Elements
@element semafloor-search-page
@demo demo/index.html
@hero hero.svg
-->
<dom-module id="semafloor-search-page">

  <template>
    <style include="semafloor-search-page-theme"></style>

    <div class="date-container search-item">
      <div class="date-icon-column item-icon-column">
        <iron-icon icon="icons:query-builder"></iron-icon>
      </div>
      <div class="date-column item-data-column">
        <div class="all-day-row">
          <span>All-day</span>
          <div></div>
          <paper-toggle-button checked="{{_allDayToggle}}"></paper-toggle-button>
        </div>
        <div class="from-date-row">
          <paper-button on-tap="_addFromDate">[[_fromDate]]</paper-button>
          <div></div>
          <paper-button id="fromTimeButton" on-tap="_addFromTime">[[_fromTime]]</paper-button>
        </div>
        <div class="to-date-row">
          <paper-button on-tap="_addToDate">[[_toDate]]</paper-button>
          <div></div>
          <paper-button id="toTimeButton" on-tap="_addToTime">[[_toTime]]</paper-button>
        </div>
      </div>
    </div>

    <div class="capacity-container search-item">
      <div class="capacity-icon-column item-icon-column">
        <iron-icon icon="social:person-add"></iron-icon>
      </div>
      <div class="capacity-column item-data-column">
        <div class="capacity-row">
          <paper-button on-tap="_addPerson">[[_capacity]]</paper-button>
        </div>
      </div>
    </div>

    <div class="site-container search-item">
      <div class="site-icon-column item-icon-column">
        <iron-icon icon="icons:room"></iron-icon>
      </div>
      <div class="site-column item-data-column">
        <div class="site-row">
          <paper-button on-tap="_addSite">[[_site]]</paper-button>
        </div>
      </div>
    </div>

    <div class="floor-container search-item">
      <div class="floor-icon-column item-icon-column">
        <iron-icon icon="social:location-city"></iron-icon>
      </div>
      <div class="floor-column item-data-column">
        <div class="floor-row">
          <paper-button on-tap="_addFloor">[[_floor]]</paper-button>
        </div>
      </div>
    </div>

    <div class="types-container search-item">
      <div class="types-icon-column item-icon-column">
        <iron-icon icon="icons:create"></iron-icon>
      </div>
      <div class="types-column item-data-column">
        <div class="types-row" on-iron-change="_getWhatBeingChecked">
          <paper-checkbox data-checked="ar">Adjoining Room (Operable Wall)</paper-checkbox>
          <paper-checkbox data-checked="pb">Panaboard</paper-checkbox>
          <paper-checkbox data-checked="pca">Polycom CX100 (Audio)</paper-checkbox>
          <paper-checkbox data-checked="pcv">Polycom CX5000 (Video Conferencing)</paper-checkbox>
          <paper-checkbox data-checked="pj">Projector</paper-checkbox>
          <paper-checkbox data-checked="pcf">Projector Cable Faulty</paper-checkbox>
          <paper-checkbox data-checked="pf">Projector Faulty</paper-checkbox>
          <paper-checkbox data-checked="spf">Screen Projector Faulty</paper-checkbox>
          <paper-checkbox data-checked="sb">SmartBoard 800</paper-checkbox>
          <paper-checkbox data-checked="tp">Telepresence</paper-checkbox>
          <paper-checkbox data-checked="tv">TV</paper-checkbox>
          <paper-checkbox data-checked="wg">Writing Glass</paper-checkbox>
        </div>
      </div>
    </div>

    <div class="send-button-container">
      <paper-button class="send-button" on-tap="_sendParams">
        <iron-icon icon="icons:send"></iron-icon>
        <span>Send</span>
      </paper-button>
    </div>

    <!-- dialogs: capacity, site, floor. -->
    <paper-dialog id="addPersonDialog" with-backdrop>
      <h2>Add Person</h2>
      <paper-dialog-scrollable>
        <p>
          numerum nec posse intrare
          <paper-input label="capacity" type="number" min="1" max="99" value="{{_inputCap::input}}" placeholder="1"></paper-input>
        </p>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm on-tap="_updateCapacity">ok</paper-button>
      </div>
    </paper-dialog>
    <paper-dialog id="addSiteDialog" with-backdrop>
      <h2>Add Site</h2>
      <p>
        Nihil hic tantum, utrum voles volo te locum eligere lobortis mauris
        <paper-dropdown-menu label="Site">
          <paper-listbox class="dropdown-content" selected="{{_inputSite}}" attr-for-selected="data-site">
            <template is="dom-repeat" items="[[_allSites]]" index-as="index">
              <paper-item data-site$="[[item]]">[[item]]</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>
      </p>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm on-tap="_updateSite">Accept</paper-button>
      </div>
    </paper-dialog>
    <paper-dialog id="addFloorDialog" with-backdrop>
      <h2>Add Floor</h2>
      <p>
        Nihil hic multum iustus volo ut lego iam post tabulatum dilexisti locum lobortis mauris utrum voles
        <paper-dropdown-menu label="Floor">
          <paper-listbox class="dropdown-content" selected="{{_inputFloor}}" attr-for-selected="data-floor">
            <template is="dom-repeat" items="[[_allFloors]]" index-as="index">
              <paper-item data-floor$="[[item]]" disabled="[[_isDisabled(_site, item)]]">[[item]]</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>
      </p>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm on-tap="_updateFloor">Accept</paper-button>
      </div>
    </paper-dialog>

    <!-- pickers dialog -->
    <jv-datepicker-dialog id="fromDate" with-backdrop disable-days='"[0,6]"' bind-date="{{_fromDate}}"></jv-datepicker-dialog>
    <jv-datepicker-dialog id="toDate" with-backdrop disable-days='"[0,6]"' bind-date="{{_toDate}}"></jv-datepicker-dialog>
    <compound-timepicker-dialog id="fromTime" with-backdrop time="{{_fromTime}}" time-format="24"></compound-timepicker-dialog>
    <compound-timepicker-dialog id="toTime" with-backdrop time="{{_toTime}}" time-format="24"></compound-timepicker-dialog>

    <!-- show query result  -->
    <paper-dialog id="responseDialog">
      <h2>Header</h2>
      <paper-dialog-scrollable>
        Lorem ipsum
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm>Accept</paper-button>
      </div>
    </paper-dialog>
  </template>

</dom-module>

<script>

  var _notafulldate = new Date();
  var _notayear = _notafulldate.getFullYear();
  var _notamonth = _notafulldate.getMonth();
  var _notadate = _notafulldate.getDate();
  var _today = _notayear + '-' + (_notamonth + 1) + '-' + _notadate;
  var _time = _notafulldate.toTimeString().slice(0, 5);
  var _sitesArray = ['Any Site','KLB - Tower 5','KLB - Tower 2A','SUITE'];
  var _floorsArray = ['Any Floor','Level 1','Level 2','Level 3','Level 3A','Level 5','Level 6','Level 7','Level 8','Level 9','Level 10','Level 11','Level 12',];
  var _typesArray = ['ar','pb','pca','pcv','pj','pcf','pf','spf','sb','tp','tv','wg'];
  var _typesResult = [0,0,0,0,0,0,0,0,0,0,0,0];

  Polymer({

    is: 'semafloor-search-page',

    properties: {

      _allDayToggle:  {
        type: Boolean,
        value: false
      },
      _capacity: {
        type: Number,
        value: 1
      },
      _allFloors: {
        type: Array,
        value: function () {
          return _floorsArray;
        }
      },
      _inputFloor: {
        type: String,
        value: 'Any Floor'
      },
      _floor: {
        type: String,
        value: 'Any Floor'
      },
      _floors: {
        type: String,
        value: ''
      },
      _allSites: {
        type: Array,
        value: function () {
          return _sitesArray;
        }
      },
      _inputSite: {
        type: String,
        value: 'Any Site'
      },
      _site: {
        type: String,
        value: 'Any Site'
      },
      _sites: {
        type: String,
        value: ''
      },
      _inputCap: Number,
      _totalCap: {
        type: Array,
        value: function () {
          return _.fill(Array(99), 1);
        }
      },
      _toDate: {
        type: String,
        value: function () {
          return  _today;
        }
      },
      _toTime: {
        type: String,
        value: function () {
          return _time;
        }
      },
      _fromDate: {
        type: String,
        value: function () {
          return _today;
        }
      },
      _fromTime: {
        type: String,
        value: function () {
          return _time;
        }
      },
      _types: String,

    },

    observers: ['_hideTime(_allDayToggle)'],

    // Element Lifecycle

    ready: function() {
      // `ready` is called after all elements have been configured, but
      // propagates bottom-up. This element's children are ready, but parents
      // are not.
      //
      // This is the point where you should make modifications to the DOM (when
      // necessary), or kick off any processes the element wants to perform.
    },

    attached: function() {
      // `attached` fires once the element and its parents have been inserted
      // into a document.
      //
      // This is a good place to perform any work related to your element's
      // visual state or active behavior (measuring sizes, beginning animations,
      // loading resources, etc).
    },

    detached: function() {
      // The analog to `attached`, `detached` fires when the element has been
      // removed from a document.
      //
      // Use this to clean up anything you did in `attached`.
    },

    // Element Behavior

    /**
     * The `semafloor-search-page-lasers` event is fired whenever `fireLasers` is called.
     *
     * @event semafloor-search-page-lasers
     * @detail {{sound: String}}
     */

     _addPerson: function (ev) {
       var _target = ev.target;

       if (_target && _target.tagName === 'PAPER-BUTTON') {
         this.$.addPersonDialog.open();
       }
       _target = null;
     },
     _updateCapacity: function (ev) {
       this.set('_capacity', this._inputCap);
     },

     _addSite: function (ev) {
       var _target = ev.target;

       if (_target && _target.tagName === 'PAPER-BUTTON') {
         this.$.addSiteDialog.open();
       }
       _target = null;
     },
     _updateSite: function (ev) {
      var _site = _.indexOf(_sitesArray, this._inputSite);
      var _siteCode = ['', '05tower', '2atower', 'suite'][_site];
      this.set('_sites', _siteCode);
      this.set('_site', this._inputSite);
     },

     _addFloor: function (ev) {
       var _target = ev.target;
       if (_target && _target.tagName === 'PAPER-BUTTON') {
         this.$.addFloorDialog.open();
       }
       _target = null;
     },
     _updateFloor: function (ev) {
       var _floor = _.indexOf(_floorsArray, this._inputFloor);
       var _floorCode = ['','01level','02level','03level','04level','05level','06level','07level','08level','09level','10level','11level','12level'][_floor];
       this.set('_floors', _floorCode);
       this.set('_floor', this._inputFloor);
     },

     _isDisabled: function (_site, _item) {
       var _siteBeingSelected = _site;
       // private method to make things tidier?
       function _updateMenu(_site) {
         var _floor = _site === 'suite' ? 'Level 1' : 'Level 3';
         // 'Any Floor' is used to escape from the dropdown menu.
         if (_item === _floor || _item === 'Any Floor') {
           this.set('_floor', _floor);
           this.set('_inputFloor', _floor);
           return false;
         }else {
           return true;
         }
       }

       switch (_siteBeingSelected) {
         case 'KLB - Tower 2A':
           return _updateMenu.call(this, '2atower');
           break;
         case 'SUITE':
           return _updateMenu.call(this, 'suite');
           break;
         default:
          //  console.log('any floor for any site.');
           return false;
       }
     },

     _addFromDate: function (ev) {
       var _target = ev.target;

       if (_target && _target.tagName === 'PAPER-BUTTON') {
         this.$.fromDate.open();
       }
       _target = null;
     },
     _addToDate: function (ev) {
       var _target = ev.target;

       if (_target && _target.tagName === 'PAPER-BUTTON') {
         this.$.toDate.open();
       }
       _target = null;
     },
     _addFromTime: function (ev) {
       var _target = ev.target;

       if (_target && _target.tagName === 'PAPER-BUTTON') {
         this.$.fromTime.open();
       }
       _target = null;
     },
     _addToTime: function (ev) {
       var _target = ev.target;

       if (_target && _target.tagName === 'PAPER-BUTTON') {
         this.$.toTime.open();
       }
       _target = null;
     },

     _hideTime: function (_toggle) {
       if (_toggle) {
         this.$.fromTimeButton.classList.add('all-day-hide-time');
         this.$.toTimeButton.classList.add('all-day-hide-time');
       }else {
         this.$.fromTimeButton.classList.remove('all-day-hide-time');
         this.$.toTimeButton.classList.remove('all-day-hide-time');
       }
     },

     // get which `paper-checkbox` being checked or unchecked.
     _getWhatBeingChecked: function (ev) {
       var _target = ev.target;

       if (_target && _target.tagName === 'PAPER-CHECKBOX') {
         if (_target.hasAttribute('data-checked')) {
           var _chk = _target.getAttribute('data-checked');
           var _toggle = _target.checked;
           var _typeIdx = _.indexOf(_typesArray, _chk);
           var _typesBin, _typesHex;

          // modify value on corresponding index.
          _typesResult[_typeIdx] = +_toggle;

          // convert array into binary String then into HEX.
          _typesBin = _typesResult.join('');
          _typesHex = parseInt(_typesBin, 2).toString(16);

          // save final result.
          this._types = _typesHex;
         }
       }
     },

     // aggregate all inputs before sending it out as request.
     _sendParams: function (ev) {
       var _params = '';
       var _fromTime = this._fromTime;
       var _toTime = this._toTime;

       if (this._allDayToggle) {
         _fromTime = '08:00';
         _toTime = '23:30';
       }

      //  console.log(this['_fromDate']);
      //  console.log(this._toDate);
      //  console.log(this._fromTime);
      //  console.log(this._toTime);
      //  console.log(this._allDayToggle);
      //  console.log(this._capacity);
      //  console.log(this._sites);
      //  console.log(this._floors);
      //  console.log(this._types);
       _params = 'startDate=' + encodeURIComponent(this._fromDate) + '&' +
                 'endDate=' + encodeURIComponent(this._toDate) + '&' +
                 'tStart=' + encodeURIComponent(_fromTime) + '&' +
                 'tEnd=' + encodeURIComponent(_toTime) + '&' +
                 'capacity=' + encodeURIComponent(this._capacity) + '&' +
                 'site=' + encodeURIComponent(this._sites) + '&' +
                 'floor=' + encodeURIComponent(this._floors) + '&' +
                 'types=' + encodeURIComponent(this._types)

      console.log(_params);
      this.$.responseDialog.open();
     },

  });

</script>
